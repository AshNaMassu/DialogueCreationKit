@page "/"
@page "/create"
@using DialogueCreationKit.DialogueKit.Components
@using DialogueCreationKit.DialogueKit.Enums;
@using DialogueCreationKit.DialogueKit.Managers;
@using DialogueCreationKit.DialogueKit.Models
@using System.Text.Json;
@using System.ComponentModel.DataAnnotations;
@using System.Globalization;

<style>
    .grid-row {
        padding-top: 8px;
        padding-bottom: 8px;
    }

        .grid-row.main {
            height: 100%;
        }

    .grid-col-main {
        background-color: #0000ff05;
        padding-left: 16px;
        padding-right: 16px;
        height: 100%;
        overflow-y: auto;
    }

</style>

@inject DialogueCreationModel Model

<GridRow Class="grid-row main">
    <!--main-->
    <GridCol Span="12" Class="grid-col-main" >
        <!--col 0-->
        <GridRow Class="grid-row ">
            <GridCol Span=8>
                <Select @bind-Value="@Model.Mode"
                        DefaultValue="@DialogueCreateMode.Dialogue"
                        TItemValue="DialogueCreateMode"
                        TItem="string" >
                    <SelectOptions>
                        <SelectOption TItemValue="DialogueCreateMode" TItem="string" Value="@DialogueCreateMode.Dialogue" Label="Диалог" />
                        <SelectOption TItemValue="DialogueCreateMode" TItem="string" Value="@DialogueCreateMode.RandomMessages" Label="Рандомные сообщения" />
                    </SelectOptions>
                </Select>
            </GridCol>

            <GridCol Flex=@("16px") />

            <GridCol Span="5" Offset="4">
                <Button Block Icon="@IconType.Outline.Sync" OnClick="@(() => DialogueCreationManager.CreateMessageList(Model))">Обновить</Button>
            </GridCol>

        </GridRow>

        @if (Model.Mode == DialogueCreateMode.Dialogue)
        {
            <GridRow Class="grid-row ">
                <GridCol Flex=@("auto")>
                    @if (Model.Actor != null && Model.Companion != null)
                    {
                        <GridRow Class="grid-row ">
                            <GridCol Span=4>
                                Главный герой
                            </GridCol>
                        </GridRow>
        
                        <GridRow Class="grid-row ">
                            <GridCol Span="12">
                                <Input @bind-Value="@Model.Actor.Name" Placeholder="Имя" />
                            </GridCol>
                        </GridRow>
        
                        <GridRow Class="grid-row ">
                            <GridCol Span="12">
                                <Input @bind-Value="@Model.Actor.Id" Placeholder="@Guid.Empty.ToString()" />
                            </GridCol>
                            <GridCol Flex=@("16px")/>
                            <GridCol Span="8">
                                <Button OnClick="@(() => Model.Actor.Id = Guid.NewGuid())">Сгенерировать</Button>
                            </GridCol>
                        </GridRow>

                        <GridRow Class="grid-row ">
                            <GridCol Span=4>
                                Собеседник
                            </GridCol>
                        </GridRow>

                        <GridRow Class="grid-row ">
                            <GridCol Span="12">
                                <Input @bind-Value="@Model.Companion.Name" Placeholder="Имя" />
                            </GridCol>
                        </GridRow>

                        <GridRow Class="grid-row ">
                            <GridCol Span="12">
                                <Input @bind-Value="@Model.Companion.Id" Placeholder="@Guid.Empty.ToString()" />
                            </GridCol>
                            <GridCol Flex=@("16px") />
                            <GridCol Span="8">
                                <Button OnClick="@(() => Model.Companion.Id = Guid.NewGuid())">Сгенерировать</Button>
                            </GridCol>
                        </GridRow>
                    }
                </GridCol>
            </GridRow>
        }

        <GridRow Class="grid-row ">
            <GridCol Span="24">
                <GridRow Class="grid-row ">
                    <GridCol Span=8>
                        Содержание диалога
                    </GridCol> 
                </GridRow>
            
                <GridRow Class="grid-row ">
                    <GridCol Flex=@("auto")>
                        <TextArea Placeholder=@($"- Реплика 1\n- Реплика 2\n- Реплика 3\n- Реплика 4\n") AutoSize MaxRows="15" Value="@Model.Content" DebounceMilliseconds="100" OnChange="OnContentChanged" />
                    </GridCol>
                </GridRow>
                <GridRow Class="grid-row ">
                    <GridCol Span="24">
                        <Button Block Icon="@IconType.Outline.Sync" OnClick="@(() => DialogueCreationManager.CreateMessageList(Model))">Обновить</Button>
                    </GridCol>
                </GridRow>
            </GridCol>
        </GridRow>
    <!--col 0-->
    </GridCol>

    <GridCol Span="12" Class="grid-col-main">
        <GridRow Class="grid-row ">
            <GridCol Flex=@("auto")>
                <AntList DataSource="@Model.ListMessages" ItemLayout="@ListItemLayout.Vertical">
                    <ChildContent Context="item">
                            <MessageView Message="@item" OnDrop="e=>OnDrop(e, item)" OnDragStart="e=>OnDragStart(e, item)" UpdateTheme="UpdateTheme" />
                    </ChildContent>
                </AntList>
            </GridCol>
        </GridRow>
    </GridCol>
<!--main-->
</GridRow>
@*
<GridRow Class="grid-row ">
    <GridCol Span="24">
        <Button Type="@ButtonType.Primary" Block OnClick="( () => CreateDialogueManager.CreateDialogue(Model) )">Создать дерево диалога</Button>
    </GridCol>
</GridRow>
*@

@code {
    protected override Task OnInitializedAsync()
    {
        Model.Content = _content;

        return base.OnInitializedAsync();
    }

    private void UpdateTheme()
    {
        DialogueCreationManager.UpdateTheme(Model);
    }

    private void OnContentChanged(string value)
    {
        if (!Model.Content.Equals(value))
        {
            Model.Content = value;

            DialogueCreationManager.CreateMessageList(Model);
        }
    }

    public string _content { get; set; } =
        "- привет" + Environment.NewLine +
        "- привет" + Environment.NewLine +
        "- как дела?" + Environment.NewLine +
        "- хорошо, сам как?" + Environment.NewLine +
        "- да в целом неплохо. что собираешься делать?" +Environment.NewLine +
        "- посижу поработаю, а дальше хз" +Environment.NewLine +
        "- план хороший" +Environment.NewLine +
        "- да, мне тоже нравится" +Environment.NewLine +
        "- ну ладно, я погнал" +Environment.NewLine +
        "- а ты куда?" +Environment.NewLine +
        "- да в деревушку" +Environment.NewLine +
        "- хэх, забавно" + Environment.NewLine +
        "- ага, ладно, пока" + Environment.NewLine +
        "- удачи";


    private DialogueMessageView _dragging;

    void OnDrop(DragEventArgs e, DialogueMessageView s)
    {
        if (s != null  && _dragging != null)
        {
            int index = Model.ListMessages.IndexOf(s);
            Model.ListMessages.Remove(_dragging);
            Model.ListMessages.Insert(index, _dragging);
            _dragging = null;
            DialogueCreationManager.CreateDialogueTreeNode(Model);

            Model.Content = "- " + string.Join("\n- ", Model.ListMessages.Select(x => x.Message.Content));

            StateHasChanged();
        }
    }

    void OnDragStart(DragEventArgs e, DialogueMessageView s)
    {
        e.DataTransfer.DropEffect = "move";
        e.DataTransfer.EffectAllowed = "move";
        _dragging = s;
    }
}